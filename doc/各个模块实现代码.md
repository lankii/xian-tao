### 主体模块及实现功能

- 用户模块

  - **注册页**

    - 注册时校验用户是否已被注册。

    ```go
    // 获取数据
    	userName := this.GetString("user_name")
    	password := this.GetString("pwd")
    	confirmPassword := this.GetString("cpwd")
    	email := this.GetString("email")
    
    	// 校验数据
    	// 判断是否为空
    	if userName == "" || password == "" || confirmPassword == "" || email == "" {
    		this.Data["errMsg"] = "数据填写不完整，请重新输入~"
    		this.TplName = "register.html"
    		return
    	}
    	// 判断密码与确认密码是否一致
    	if password != confirmPassword {
    		this.Data["errMsg"] = "两次密码输入的不一致，请重新输入~"
    		this.TplName = "register.html"
    		return
    	}
    	// 使用正则判断邮箱格式
    	regex, _ := regexp.Compile("\\w[-\\w.+]*@([A-Za-z0-9][-A-Za-z0-9]+\\.)+[A-Za-z]{2,14}")
    	resEmail := regex.FindString(email)
    	if resEmail == "" {
    		this.Data["errMsg"] = "邮箱格式不正确，请重新输入~"
    		this.TplName = "register.html"
    		return
    	}
    
    	// 处理数据
    	o := orm.NewOrm()
    	user := models.User{}
    	user.Name = userName
    	user.Password = password
    	user.Email = email
    	_, err := o.Insert(&user)
    	if err != nil {
    		this.Data["errMsg"] = "用户名已经存在，请重新输入~"
    		this.TplName = "register.html"
    		return
    	}
    ```

    - 给注册用户发送激活邮件，用户点击邮件中的链接完成用户激活。

    ```go
    	// 发送激活邮件
    	emailConfig := `{"username":"发送邮箱地址","password":"邮箱授权码","host":"smtp.qq.com","port":587}`
    	emailConn := utils.NewEMail(emailConfig)
    	emailConn.From = "431592976@qq.com" // 指定发件人的邮箱地址
    	emailConn.To = []string{user.Email} // 指定收件人邮箱地址
    	emailConn.Subject = "鲜淘驿站用户激活"      // 指定邮件的标题
    	// 发给用户的是激活请求地址
    	emailConn.HTML = `尊敬的` + user.Name + `，您好<br><br>感谢您注册鲜淘驿站，为了避免您忘记账号或密码导致您的账户无法找回，请您验证Email地址。<br><br>请复制粘贴下面的链接至浏览器地址栏打开：<br><br>127.0.0.1:8080/active?id=` + strconv.Itoa(user.Id) + `<br>`
    	err = emailConn.Send()
    	if err != nil {
    		this.Data["errMsg"] = "发送激活邮件失败，请重新发送~"
    		this.TplName = "register.html"
    		return
    	}
    ```

    - 完成用户信息的注册。

  

  - **登录页**

    - 实现用户的登录功能。

    ```go
    	// 获取数据
    	userName := this.GetString("username")
    	password := this.GetString("pwd")
    	// 校验数据
    	if userName == "" || password == "" {
    		this.Data["errMsg"] = "用户名或密码不能为空"
    		this.TplName = "login.html"
    		return
    	}
    
    	// 处理数据
    	o := orm.NewOrm()
    	var user models.User
    	user.Name = userName
    	err := o.Read(&user, "Name")
    	if err != nil {
    		this.Data["errMsg"] = "用户名或密码错误"
    		this.Data["userName"] = userName
    		this.TplName = "login.html"
    		return
    	}
    	if user.Password != password {
    		this.Data["errMsg"] = "用户名或密码错误"
    		this.Data["userName"] = userName
    		this.TplName = "login.html"
    		return
    	}
    	if user.Active != true {
    		this.Data["errMsg"] = "用户名未激活，请先前往邮箱激活"
    		this.Data["userName"] = userName
    		this.TplName = "login.html"
    		return
    	}
    	// 记住用户名处理
    	rememberMe := this.GetString("remember_me")
    	if rememberMe == "on" {
    		// base64加密
    		tempUserName := base64.StdEncoding.EncodeToString([]byte(userName))
    		this.Ctx.SetCookie("userName", tempUserName, time.Second*3600*24*3)
    	} else {
    		this.Ctx.SetCookie("userName", userName, -1)
    	}
    	// 登录成功，设置session
    	this.SetSession("userName", userName)
    ```

    

  - **用户中心**

    - 用户中心信息页：显示登录用户的信息，包括用户名、电话和地址，**同时页面下方显示出用户最近浏览的商品信息（Redis存储）**。

    ```go
    	userName := this.GetSession("userName")
    	this.Data["userName"] = userName
    	// 查询地址表的内容
    	o := orm.NewOrm()
    	// 表关联
    	var addr models.Address
    	o.QueryTable("Address").RelatedSel("User").Filter("User__Name", userName).Filter("IsDefault", true).One(&addr)
    	if addr.Id == 0 {
    		this.Data["addr"] = ""
    	} else {
    		this.Data["addr"] = addr
    	}
    
    	// 获取登录用户历史浏览记录
    	var user models.User
    	user.Name = userName.(string)
    	o.Read(&user, "Name")
    
    	conn, err := redis.Dial("tcp", ":6379")
    	defer conn.Close()
    	if err != nil {
    		fmt.Println("redis连接失败")
    	}
    	var historyGoodsSKUs []models.GoodsSKU
    	rep, err := conn.Do("lrange", "history_"+strconv.Itoa(user.Id), 0, 4)
    	// 回复助手函数
    	historyGoodsIDs, _ := redis.Ints(rep, err) // 历史浏览商品ID
    
    	for _, value := range historyGoodsIDs {
    		var historyGoodsSKU models.GoodsSKU
    		historyGoodsSKU.Id = value
    		o.Read(&historyGoodsSKU)
    		historyGoodsSKUs = append(historyGoodsSKUs, historyGoodsSKU)
    	}
    	this.Data["historyGoodsSKUs"] = historyGoodsSKUs
    ```

    

    - 用户中心地址页：显示登录用户的默认收件地址，页面下方的表单可以新增用户的收货地址。

    ```go
    // 展示用户中心收货地址页面
    func (this *UserController) ShowUserAddress() {
    	userName := GetUser(&this.Controller)
    	o := orm.NewOrm()
    	var addr models.Address
    	o.QueryTable("Address").RelatedSel("User").Filter("User__Name", userName).Filter("IsDefault", true).One(&addr)
    
    	this.Data["addr"] = addr
    	this.TplName = "user_center_site.html"
    }
    
    // 处理用户中心收货地址数据
    func (this *UserController) HandleUserAddress() {
    	// 获取数据
    	receiver := this.GetString("receiver")
    	address := this.GetString("address")
    	zipCode := this.GetString("zip_code")
    	phone := this.GetString("phone")
    	// 校验数据(推荐使用正则校验，这里先使用判空)
    	if receiver == "" || address == "" || zipCode == "" || phone == "" {
    		this.Data["errMsg"] = "添加数据不完整，请重新输入~"
    		this.Data["receiver"] = receiver
    		this.Data["address"] = address
    		this.Data["zipCode"] = zipCode
    		this.Data["phone"] = phone
    		this.TplName = "user_center_site.html"
    		return
    	}
    	// 处理数据(插入数据)
    	o := orm.NewOrm()
    	var userAddress models.Address
    	userAddress.IsDefault = true
    	err := o.Read(&userAddress, "IsDefault")
    	// 添加默认地址之前需要把原来的默认地址更改成非默认地址
    	if err == nil {
    		userAddress.IsDefault = false
    		o.Update(&userAddress)
    	}
    	/*	更新默认地址时，给原来的地址对象的ID赋值了
    		这时用原来的地址对象插入意思是用原来的ID做插入操作，会报错。*/
    	// 关联用户表
    	userName := this.GetSession("userName")
    	var user models.User
    	user.Name = userName.(string)
    	o.Read(&user, "Name")
    
    	var newUserAddress models.Address
    	newUserAddress.Receiver = receiver
    	newUserAddress.Addr = address
    	newUserAddress.ZipCode = zipCode
    	newUserAddress.Phone = phone
    	newUserAddress.IsDefault = true
    	newUserAddress.User = &user
    	o.Insert(&newUserAddress)
    
    	// 返回视图
    	this.Redirect("/u/address", 302)
    }
    ```

    

    - 用户中心订单页：显示登录用户的订单信息。

  - **其它**

    - 如果用户已登录，页面顶部显示登录用户的信息。

- 商品模块

  - **首页**
    - 动态指定首页轮播商品信息
    - 动态指定首页活动信息
    - 动态获取商品的种类信息并显示
    - 动态指定首页显示的每个种类的商品（包括文字商品和图片商品）
    - 点击某一个商品时跳转到商品的详情页面

  ```go
  func (this *GoodsController) ShowIndex() {
  	userName := GetUser(&this.Controller)
  	this.Data["userName"] = userName
  
  	o := orm.NewOrm()
  	// 展示 商品类型 数据
  	var goodsTypes []models.GoodsType
  	o.QueryTable("GoodsType").All(&goodsTypes)
  	this.Data["goodsTypes"] = goodsTypes
  
  	// 展示 首页轮播商品 数据
  	var indexGoodsBanners []models.IndexGoodsBanner
  	o.QueryTable("IndexGoodsBanner").OrderBy("Index").All(&indexGoodsBanners)
  	this.Data["indexGoodsBanners"] = indexGoodsBanners
  
  	// 展示 首页促销商品 数据
  	var indexPromotionBanners []models.IndexPromotionBanner
  	o.QueryTable("IndexPromotionBanner").OrderBy("Index").All(&indexPromotionBanners)
  	this.Data["indexPromotionBanners"] = indexPromotionBanners
  
  	// 展示 分类商品 数据
  	goods := make([]map[string]interface{}, len(goodsTypes)) // 存储所有类型的商品
  	// 插入 商品类型 数据
  	for index, value := range goodsTypes {
  		// 获取对应 商品类型的首页展示商品
  		temp := make(map[string]interface{})
  		temp["type"] = value
  		goods[index] = temp
  	}
  
  	// 展示 文字商品 以及 图片商品
  	for _, value := range goods {
  		var textGoods []models.IndexTypeGoodsBanner
  		var imageGoods []models.IndexTypeGoodsBanner
  		// 获取 文字商品 数据
  		o.QueryTable("IndexTypeGoodsBanner").RelatedSel("GoodsType", "GoodsSKU").OrderBy("Index").Filter("GoodsType", value["type"]).Filter("DisplayType", 0).Limit(4, 0).All(&textGoods)
  		// 获取 图片商品 数据
  		o.QueryTable("IndexTypeGoodsBanner").RelatedSel("GoodsType", "GoodsSKU").OrderBy("Index").Filter("GoodsType", value["type"]).Filter("DisplayType", 1).Limit(4, 0).All(&imageGoods)
  		value["textGoods"] = textGoods
  		value["imageGoods"] = imageGoods
  	}
  	this.Data["goods"] = goods
  
  	// 返回视图
  	this.TplName = "index.html"
  }
  ```

  - **商品详情页**
    - 显示出某个商品的详细信息
    - 页面的左下方显示出该种类的2个新上架商品信息

  ```go
  // 显示商品详情页
  func (this *GoodsController) ShowGoodsDetail() {
  	goodsId, err := this.GetInt("id")
  	if err != nil {
  		this.Redirect("/", 302)
  		return
  	}
  	o := orm.NewOrm()
  	// 获取 商品SKU 数据
  	var goodsSKU models.GoodsSKU
  	goodsSKU.Id = goodsId
  	o.QueryTable("GoodsSKU").RelatedSel("GoodsType", "Goods").Filter("Id", goodsId).One(&goodsSKU)
  	this.Data["goodsSKU"] = goodsSKU
  
  	// 显示同类型的最新上架的两个商品
  	var newGoodsSKUs []models.GoodsSKU
  	o.QueryTable("GoodsSKU").RelatedSel("GoodsType").Filter("GoodsType", goodsSKU.GoodsType).OrderBy("Time").Limit(2, 0).All(&newGoodsSKUs)
  	this.Data["newGoodsSKUs"] = newGoodsSKUs
  
  	// 获取所有商品类型
  	GetGoodsType(&this.Controller)
  
  	// 添加登录用户的历史浏览记录
  	userName := this.GetSession("userName")
  	if userName == nil {
  		// 未登录
  		this.Data["userName"] = ""
  	} else {
  		// 已登录
  		this.Data["userName"] = userName.(string)
  
  		var user models.User
  		user.Name = userName.(string)
  		o.Read(&user, "Name")
  
  		// 添加浏览记录
  		conn, err := redis.Dial("tcp", ":6379")
  		defer conn.Close()
  		if err != nil {
  			fmt.Println("redis连接失败")
  		}
  		// 把以前相同商品的浏览记录删除
  		conn.Do("lrem", "history_" + strconv.Itoa(user.Id), 0, goodsId)
  		// 添加新的商品浏览记录
  		conn.Do("lpush", "history_" + strconv.Itoa(user.Id), goodsId)
  	}
  
  	this.TplName = "detail.html"
  }
  ```

  

- 购物车模块

- 订单模块

- 后台模块